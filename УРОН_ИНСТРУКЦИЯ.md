# Инструкция по настройке системы урона через события

## Что было сделано:

### 1. EventHitComponent (OneFrame компонент)
- Путь: `Assets/CodeBase/Components/Events/EventHitComponent.cs`
- Это компонент-событие, который автоматически удаляется в конце фрейма
- Содержит поле `Damage` для передачи урона

### 2. EnemyCollisionHandler (MonoBehaviour)
- Путь: `Assets/CodeBase/MonoBehaviours/EnemyCollisionHandler.cs`
- Вешается на префаб врага автоматически при спавне
- При столкновении с игроком (OnTriggerEnter) добавляет EventHitComponent на entity игрока

### 3. PlayerHealthDamageSystem
- Путь: `Assets/CodeBase/Systems/PlayerHealthTestSystem.cs`
- Обрабатывает все entity с PlayerHealthComponent + EventHitComponent
- Отнимает урон и удаляет компонент события

### 4. Настройка в EcsStartup
- Добавлен `.OneFrame<EventHitComponent>()` для автоматической очистки событий
- Система PlayerHealthDamageSystem зарегистрирована в Update цикле

## Как это настроить в Unity:

### Шаг 1: Настройка префаба игрока
1. Убедись, что у игрока есть Collider с `isTrigger = true` ИЛИ обычный Collider
2. Убедись, что у игрока есть тег "Player"

### Шаг 2: Настройка префаба врага
1. Добавь Collider с `isTrigger = true` на префаб врага
2. Параметр Damage можно настроить в инспекторе EnemyCollisionHandler (по умолчанию 10)
3. EnemyCollisionHandler добавится автоматически при спавне через EnemySpawnerSystem

### Шаг 3: Тестирование
1. Запусти игру
2. Враги будут спавниться и преследовать игрока
3. При столкновении с врагом:
   - В консоль выведется сообщение о столкновении
   - В консоль выведется сообщение об уроне
   - UI здоровья обновится

## Важные моменты:

### OneFrame события
- `.OneFrame<EventHitComponent>()` автоматически удаляет компонент в конце фрейма
- НО система PlayerHealthDamageSystem вручную удаляет компонент через `Del<EventHitComponent>()`
- Это сделано для явности и надёжности (двойная гарантия удаления)

### Порядок систем важен!
```csharp
.Add(new EnemySpawnerSystem())       // Спавнит врагов
.Add(new EnemyChaseSystem())         // Враги преследуют
// MonoBehaviour EnemyCollisionHandler добавляет EventHitComponent при столкновении
.Add(new PlayerHealthDamageSystem()) // Обрабатываем урон
.Add(new PlayerHealthUIUpdateSystem()) // Обновляем UI
// ...
.OneFrame<EventHitComponent>()       // Очищаем события в конце фрейма
```

## Альтернативный подход (если хочешь убрать ручное удаление):

Можешь убрать строку `_filter.GetEntity(i).Del<EventHitComponent>();` из PlayerHealthDamageSystem,
и компонент всё равно удалится автоматически благодаря `.OneFrame<>()`.

Но лучше оставить как есть - это более явно и предсказуемо.

